name: Built docker image and run tests

# This workflow is only triggered when something is pushed on develop branch.
# This workflow will built docker image and run tests inside the container.
# This workflow ensures that the after every change in "develop", the code is not breaking.
# This workflow is not executed for every PR because it seems unnecessary: we're already testing 
# the PRs using a python virtual env instead of the docker. 
# Also performing dockerized tests for every PR seems to be overkill."

on:
  push:
    paths:
      - '.github/workflows/docker-image.yml'
      - 'pyproject.tml'
    branches:
      - "develop"

  # allows to manually start a workflow run from the GitHub UI or using the GitHub API.    
  workflow_dispatch:

jobs:
  built:
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - uses: actions/checkout@v2
      - name: Build the docker image
        run: docker build --tag ai4eu_server_demo:latest -f Dockerfile .
      
      - name: Run docker container and pytest tests
        run: |
          docker run -e KEYCLOAK_CLIENT_SECRET="mocked_secret" --entrypoint "" ai4eu_server_demo sh -c "pip install \".[dev]\" && pytest tests -s"
  
  
          
  
  
    


